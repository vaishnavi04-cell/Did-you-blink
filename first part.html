<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Did You Blink?</title>
  <style>
    body { 
      text-align: center; 
      font-family: 'Brush Script MT', cursive, Arial; 
      background: #FADADD; /* blush pink background */
      overflow-x: hidden;
    }
    .picture-container {
      margin-top: 30px;
      margin-bottom: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }
    .picture-container img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      box-shadow: 0 2px 12px #ffb6c1;
      border: 4px solid #fff0f6;
      transition: transform 0.3s;
    }
    .enlarged-img {
      transform: scale(1.3);
      box-shadow: 0 4px 24px #d6336c;
      border-color: #d6336c;
    }
    h1 {
      margin-top: 10px;
      margin-bottom: 30px;
      font-size: 40px;
      color: #d6336c;
      font-family: 'Brush Script MT', cursive, Arial;
    }
    #status { font-size: 24px; margin-top: 20px; color: green; }
    #blink-status { 
      font-size:22px; 
      margin-top:10px; 
      color:#333; 
      transition: font-size 0.3s, color 0.3s; 
      font-family: cursive;
    }
    .blinked { font-size: 32px !important; color: #e74c3c !important; }
    .camera-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }
    .camera-message {
      font-size: 22px;
      color: #d6336c;
      font-family: cursive;
      margin-bottom: 8px;
      margin-top: 8px;
    }
    #timed-message {
      font-size: 24px;
      color: #d6336c;
      font-family: cursive;
      margin-top: 20px;
      min-height: 32px;
      transition: opacity 0.5s;
    }
    .small-cam { 
      width: 320px !important; 
      height: 240px !important; 
      border-radius: 16px; 
      box-shadow: 0 2px 12px #ffb6c1;
      margin: 0 auto 10px auto;
      display: block;
    }
    .small-canvas {
      width: 320px !important;
      height: 240px !important;
      display: block;
      margin: 0 auto 10px auto;
      border-radius: 16px;
      box-shadow: 0 2px 12px #ffb6c1;
    }
    #cat-gif {
      display: none;
      margin: 20px auto 0 auto;
      width: 120px;
      height: auto;
      border-radius: 16px;
      box-shadow: 0 2px 12px #ffb6c1;
    }
    #bye-message {
      font-size: 24px;
      color: #d6336c;
      font-family: cursive;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="picture-container">
    <img id="mainPic" src="c:\Users\user\Downloads\photo_6084459351545857901_x.jpg" alt="Main Picture">
  </div>
  <h1>Did You Blink?</h1>
  <div class="camera-container">
    <video id="video" class="small-cam" width="320" height="240" autoplay muted></video>
    <canvas id="output" class="small-canvas" width="320" height="240"></canvas>
    <div class="camera-message" id="cameraMessage">Smile and look at the camera</div>
  </div>
  <div id="status">Initializing...</div>
  <img id="cat-gif" src="https://media.giphy.com/media/v6aOjy0Qo1fIA/giphy.gif" alt="Cat Hi Kiss">
  <div id="blink-status"></div>
  <div id="timed-message"></div>
  <div id="bye-message">Now you wasted your 10 sec... bye ðŸ‘‹</div>

  <!-- MediaPipe Face Mesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const statusText = document.getElementById('status');
    const blinkStatus = document.getElementById('blink-status');
    const mainPic = document.getElementById('mainPic');
    const cameraMessage = document.getElementById('cameraMessage');
    const timedMessage = document.getElementById('timed-message');
    const catGif = document.getElementById('cat-gif');
    const byeMessage = document.getElementById('bye-message');

    let blinkCount = 0;
    let lastBlink = Date.now();
    let fakeCount = 0; // Track first few attempts

    // Timed messages logic
    setTimeout(() => {
      timedMessage.innerText = "You did not blink properly";
    }, 10000);

    setTimeout(() => {
      statusText.style.display = "none"; // Hide the initializing text
      catGif.style.display = "block";    // Show the cat gif
    }, 20000);

    setTimeout(() => {
      byeMessage.style.display = "block";
    }, 30000);

    function distance(a, b) {
      return Math.sqrt((a.x - b.x)**2 + (a.y - b.y)**2);
    }

    function setEnlarged(enlarge) {
      if (enlarge) {
        blinkStatus.classList.add('blinked');
        mainPic.classList.add('enlarged-img');
      } else {
        blinkStatus.classList.remove('blinked');
        mainPic.classList.remove('enlarged-img');
      }
    }

    function detectBlink(landmarks) {
      const leftEAR = (
        distance(landmarks[159], landmarks[145]) /
        distance(landmarks[33], landmarks[133])
      );

      // For first 4 attempts, randomly show status
      if (fakeCount < 4) {
        const fakeBlink = Math.random() > 0.5;
        blinkStatus.innerText = fakeBlink ? "It's blinking!" : "Not blinking";
        setEnlarged(fakeBlink);
        fakeCount++;
        return;
      }

      if (leftEAR < 0.25 && Date.now() - lastBlink > 1000) {
        blinkCount++;
        lastBlink = Date.now();
        statusText.innerText = `You blinked! Total: ${blinkCount}`;
        blinkStatus.innerText = "It's blinking!";
        setEnlarged(true);
      } else if (leftEAR >= 0.25) {
        blinkStatus.innerText = "Not blinking";
        setEnlarged(false);
      }
    }

    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
    });

    faceMesh.setOptions({
      maxNumFaces: 1,
      refineLandmarks: true,
      enableFaceGeometry: true,
      enableFaceMesh: true,
    });

    function onResults(results) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (results.multiFaceLandmarks) {
        results.multiFaceLandmarks.forEach((landmarks) => {
          detectBlink(landmarks);
          FaceMesh.drawConnectors(ctx, landmarks, FaceMesh.FACEMESH_TESSELATION, {color: '#00FF00', lineWidth: 1});
          FaceMesh.drawLandmarks(ctx, landmarks, {color: '#FF0000', lineWidth: 2});
        });
      }
    }

    const camera = new Camera(video, {
      onFrame: async () => {
        await faceMesh.send({image: video});
      },
      width: 320,
      height: 240
    });

    faceMesh.onResults = onResults;
    camera.start();
  </script>
</body>
</html>
